{{- define "main" }}
<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
  </header>

  <div class="post-content">
    <link rel="stylesheet" href="/css/habits.css">

    <div class="habits-container">
      <div class="year-selector">
        {{- $years := slice }}
        {{- range $year, $data := .Site.Data.habits }}
          {{- $years = $years | append $year }}
        {{- end }}
        {{- $years = sort $years }}
        {{- range $years }}
        <button class="year-btn" data-year="{{ . }}">{{ . }}</button>
        {{- end }}
      </div>

      {{- $habits := slice -}}
      {{- $hidden := slice -}}
      {{- range $year, $data := .Site.Data.habits -}}
        {{- if isset $data "_hidden" -}}
          {{- $hidden = $data._hidden -}}
        {{- end -}}
        {{- range $habit, $dates := $data -}}
          {{- if and (ne $habit "_hidden") (not (in $hidden $habit)) -}}
            {{- if not (in $habits $habit) -}}
              {{- $habits = $habits | append $habit -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        {{- break -}}
      {{- end -}}
      {{- $habits = sort $habits -}}

      <section class="habit-section" id="rollup-section">
        <h2>All Habits</h2>
        <p class="habit-subtitle">Combined activity across {{ len $habits }} habits</p>
        <div class="contribution-graph" id="rollup-graph"></div>
      </section>

      {{- range $habits }}
      <section class="habit-section">
        <h2>{{ . | replaceRE "-" " " | title }}</h2>
        <div class="contribution-graph" id="{{ . }}-graph"></div>
      </section>
      {{- end }}
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      const habitsData = {
        {{- range $year, $data := .Site.Data.habits }}
        {{- $hidden := slice -}}
        {{- if isset $data "_hidden" }}{{ $hidden = $data._hidden }}{{ end }}
        "{{ $year }}": {
          {{- $first := true -}}
          {{- range $habit, $dates := $data -}}
            {{- if and (ne $habit "_hidden") (not (in $hidden $habit)) -}}
              {{- if not $first }},{{ end }}{{ $first = false }}
          "{{ $habit }}": [{{ range $i, $d := $dates }}{{ if $i }},{{ end }}"{{ $d }}"{{ end }}]
            {{- end -}}
          {{- end }}
        },
        {{- end }}
      };
    </script>
    <script src="/js/habits.js"></script>
  </div>
</article>
{{- end }}
